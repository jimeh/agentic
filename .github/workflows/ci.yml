name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Run shellcheck
        run: |
          shopt -s globstar
          shellcheck **/*.sh

  markdown-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
      - name: Lint markdown files
        run: mise run lint

  plugin-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Discover and run plugin tests
        run: |
          failed=0
          found=0

          while IFS= read -r test_file; do
            found=$((found + 1))
            echo "::group::${test_file}"
            if bash "$test_file"; then
              echo "::endgroup::"
            else
              echo "::endgroup::"
              echo "::error file=${test_file}::Test failed"
              failed=$((failed + 1))
            fi
          done < <(find plugins/*/tests -name '*.test.sh' -type f | sort)

          if [[ "$found" -eq 0 ]]; then
            echo "No plugin tests found."
            exit 0
          fi

          echo ""
          echo "Ran ${found} test file(s), ${failed} failed."
          if [[ "$failed" -gt 0 ]]; then
            exit 1
          fi
